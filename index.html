<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Rainbow Staves</title>
  </head>
  <body>
    <h2>Rainbow Staves</h2>
    <p id="status">Rainbow Stave is loading...</p>
    <div>
      <div class="inputoutput">
        <img id="imageSrc" alt="" />
        <div class="caption">
          Sheet Music file to Colourize ->
          <input type="file" id="fileInput" name="file" />
        </div>
      </div>
      <div class="inputoutput">
        <canvas id="canvasOutput"></canvas>
        <!-- <div class="caption">canvasOutput</div> -->
        <!-- <canvas id="canvasOutput2"></canvas>
        <canvas id="canvasOutput3"></canvas> -->
        <!-- <div class="caption">canvasOutput2</div> -->
      </div>
    </div>
    <script type="text/javascript">
      let imgElement = document.getElementById('imageSrc');
      let inputElement = document.getElementById('fileInput');
      inputElement.addEventListener(
        'change',
        (e) => {
          imgElement.src = URL.createObjectURL(e.target.files[0]);
        },
        false
      );

      function myCode() {
        let src = cv.imread(imgElement);
        let dst = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);

        gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_BGR2GRAY, 0);
        thresh = new cv.Mat();
        cv.threshold(
          gray,
          thresh,
          0,
          255,
          cv.THRESH_BINARY_INV + cv.THRESH_OTSU
        )[1];

        let horizontal_kernel = cv.Mat.ones(1, 40, cv.CV_8U);
        let anchor = new cv.Point(-1, -1);

        detect_horizontal = new cv.Mat();
        cv.morphologyEx(
          thresh,
          detect_horizontal,
          cv.MORPH_OPEN,
          horizontal_kernel,
          anchor,
          2
        );

        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        let poly = new cv.MatVector();

        cv.findContours(
          detect_horizontal,
          contours,
          hierarchy,
          cv.RETR_EXTERNAL,
          cv.CHAIN_APPROX_SIMPLE
        );

        // cnts = cnts[0] if len(cnts) == 2 else cnts[1]
        // SORT (cnts, boundingBoxes) = sort_contours(cnts, method="top-to-bottom")
        // REMOVE HORIZONTAL LINES THAT ARE TOO SHORT (ONLY USE THE LONG ONES)
        const colours = [
          new cv.Scalar(87, 80, 245), // red (line 1)
          new cv.Scalar(231, 177, 237),
          new cv.Scalar(220, 74, 67),
          new cv.Scalar(180, 216, 165),
          new cv.Scalar(100, 230, 223),
          new cv.Scalar(60, 172, 252),
          new cv.Scalar(87, 80, 245),
          new cv.Scalar(204, 95, 213),
          new cv.Scalar(220, 74, 67),
          new cv.Scalar(180, 216, 165),
        ];

        for (let i = 0; i < contours.size(); ++i) {
          let tmp = new cv.Mat();
          let cnt = contours.get(i);
          // You can try more different parameters
          cv.approxPolyDP(cnt, tmp, 3, true);
          poly.push_back(tmp);
          cnt.delete();
          tmp.delete();
        }

        src.copyTo(dst);

        // draw contours with random Scalar
        let colour_idx = 0;
        for (let i = 0; i < contours.size(); ++i) {
          let colour = colours[colour_idx];
          colour_idx = colour_idx + 1;
          if (colour_idx == colours.length) colour_idx = 0;
          cv.drawContours(dst, poly, i, colour, 1, 8, hierarchy, 0);
        }

        // cv.imshow('canvasOutput', gray);
        // cv.imshow('canvasOutput', thresh);
        // cv.imshow('canvasOutput', detect_horizontal);
        cv.imshow('canvasOutput', dst);
        // cv.imshow('canvasOutput3', result);

        // for c in cnts:
        //     cv2.drawContours(result, [c], -1, colors[color_idx], 2)
        //     color_idx += 1
        //     if color_idx == len(colors):
        //         color_idx = 0

        // edge_kernel = np.array([[ 0.0, -1, 0],
        //                         [ -1, 4, -1],
        //                         [ 0, -1, 0]], dtype=np.uint8)
        // detect_edge = cv2.morphologyEx(thresh, cv2.MORPH_OPEN, edge_kernel, iterations=2)
        // cnts = cv2.findContours(detect_edge, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        // cnts = cnts[0] if len(cnts) == 2 else cnts[1]
        // for c in cnts:
        //     cv2.fillPoly(result, [c], (0,0,0))

        //
        // mat.delete();
        src.delete();
        dst.delete();
        hierarchy.delete();
        contours.delete();
        poly.delete();
      }
      imgElement.onload = function () {
        myCode();
      };
      function onOpenCvReady() {
        document.getElementById('status').innerHTML =
          'Rainbow Stave is ready. Please click on the "Choose file" button to select your sheet music file on your computer.';
      }
    </script>
    <script
      async
      src="opencv.js"
      onload="onOpenCvReady();"
      type="text/javascript"
    ></script>
  </body>
</html>
