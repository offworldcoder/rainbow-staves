<!DOCTYPE html>
      <!-- 
        TODO:
          SAVE OPTIONS
          use PDF's
        -->

<html>
  <head>
    <style>
      body {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
      }
    </style>
    <meta charset="utf-8" />
    <img
    id="wholenote-1"
    src="./note-images/wholenote-1.png"
    style="display: none"
  />
  <img
    id="wholenote-2"
    src="./note-images/wholenote-2.png"
    style="display: none"
  />
  <img
    id="wholenote-3"
    src="./note-images/wholenote-3.png"
    style="display: none"
  />
  <img
    id="wholenote-4"
    src="./note-images/wholenote-4.png"
    style="display: none"
  />
  <img
    id="google-wholenote-1"
    src="./note-images/google-wholenote-1.png"
    style="display: none"
  />
  <img
    id="google-wholenote-2"
    src="./note-images/google-wholenote-2.png"
    style="display: none"
  />
</head>

  <body>
    <table width="100%" height="300px" border="0">
      <tr>
        <td align="center">
          <img src="./images/title.png" width="400" />
        </td>
      </tr>
      <tr>
        <td id="loading" align="center">
          <h1>Loading...</h1>
        </td>
        <tr>
          <td style="padding:0px 150px 0px 150px" id="status" height="100px"></td>
        </tr>
        <tr>
          <td style="padding-left: 150px" class="inputoutput" id="inputoutput" style="display: none">
            <div id="caption" class="caption">
              Sheet Music file to Colourize ->
              <input type="file" id="fileInput" name="file" />
            </div>    
          </td>
        </tr>
        <tr>
          <td>
            <canvas id="debugOutput"></canvas>
          </td>
        </tr>
        <tr>
          <td>
            <canvas id="canvasOutput"></canvas>
          </td>
        </tr>
        <tr>
          <td>
            <h3>Original image:</h3><br/>
            <img id="imageSrc" alt="" />
          </td>
        </tr>
      </tr>
    </table>
    <script type="text/javascript">
      const DEBUG_STAVE_TEXT = false;
      const DEBUG_NOTE_TEXT = false;
      let imgElement = document.getElementById("imageSrc");
      let inputElement = document.getElementById("fileInput");
      inputElement.addEventListener(
        "change",
        (e) => {
          imgElement.src = URL.createObjectURL(e.target.files[0]);
          document.getElementById("caption").style.display = "none";
        },
        false
      );

      function loadNoteImage(filename, imageList) {
        const wholeNote = cv.imread(filename, 0);
        wholeNote2 = new cv.Mat();
        cv.cvtColor(wholeNote, wholeNote2, cv.COLOR_BGR2GRAY, 0);
        imageList.push(wholeNote2);
      }

      imgElement.onload = function () {
        let src = cv.imread(imgElement);

        // Preprocess Convert everything to grayscale
        gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_BGR2GRAY, 0);

        //TODO: loop through note images in directory
        wholeNotes = [];
        loadNoteImage("wholenote-1", wholeNotes);
        // loadNoteImage("wholenote-2", wholeNotes);
        // loadNoteImage("wholenote-3", wholeNotes);
        // loadNoteImage("wholenote-4", wholeNotes);
        // loadNoteImage("google-wholenote-1", wholeNotes);
        // loadNoteImage("google-wholenote-2", wholeNotes);
        console.log(`wholeNotes ${wholeNotes.length}`);
        thresh = new cv.Mat();
        cv.threshold(
          gray,
          thresh,
          0,
          255,
          cv.THRESH_BINARY_INV + cv.THRESH_OTSU
        )[1];

        const { maxLength, sortedContours } = findTheStaves(thresh);
        console.log(`Number of stave lines found ${sortedContours.length}`);

        const notePositions = findTheNotes(gray, src, wholeNotes);
        const newContours = cutoutNotesFromStaves(
          sortedContours,
          notePositions,
          src
        );
        drawStaves(newContours, src, maxLength);
        cv.imshow("canvasOutput", src);

        // writeFileSync('output.jpg', canvas.toBuffer('image/jpeg'));

        // Clean up
        wholeNotes = [];
        src.delete();
        gray.delete();
        thresh.delete();
      };

      function onOpenCvReady() {
        document.getElementById("loading").style.display = "none";
        document.getElementById("inputoutput").style.display = "block";
        document.getElementById("status").innerHTML =
          'Rainbow Stave is ready. Please click on the "Choose file" button to select your sheet music file on your computer. Currently this should be an image file, eg. .jpg or .png<br/><br/>The sheet music is processed on your computer and NOT uploaded to any server.';
      }
    </script>
    <script
      async
      src="https://docs.opencv.org/3.4/opencv.js"
      onload="onOpenCvReady();"
      type="text/javascript"
    ></script>
    <script src="utils/finders.js"></script>
    <script src="utils/rainbowstaves.js"></script>
  </body>
</html>
